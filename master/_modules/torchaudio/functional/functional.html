


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torchaudio.functional.functional &mdash; Torchaudio master documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/katex-math.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/elastic/">
                  <span class="dropdown-title">TorchElastic</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorch’s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href='https://pytorch.org/audio/versions.html'>master  &#x25BC</a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Package Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../torchaudio.html">torchaudio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../backend.html">torchaudio.backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../functional.html">torchaudio.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../transforms.html">torchaudio.transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../datasets.html">torchaudio.datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../models.html">torchaudio.models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sox_effects.html">torchaudio.sox_effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compliance.kaldi.html">torchaudio.compliance.kaldi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kaldi_io.html">torchaudio.kaldi_io</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils.html">torchaudio.utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../transducer.html">torchaudio.prototype.transducer</a></li>
</ul>
<p class="caption"><span class="caption-text">PyTorch Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/docs">PyTorch</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/text">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/elastic/">TorchElastic</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pytorch.org/xla/">PyTorch on XLA Devices</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
      <li>torchaudio.functional.functional</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torchaudio.functional.functional</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">torchaudio._internal</span> <span class="kn">import</span> <span class="n">module_utils</span> <span class="k">as</span> <span class="n">_mod_utils</span>
<span class="kn">import</span> <span class="nn">torchaudio</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;spectrogram&quot;</span><span class="p">,</span>
    <span class="s2">&quot;griffinlim&quot;</span><span class="p">,</span>
    <span class="s2">&quot;amplitude_to_DB&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DB_to_amplitude&quot;</span><span class="p">,</span>
    <span class="s2">&quot;compute_deltas&quot;</span><span class="p">,</span>
    <span class="s2">&quot;compute_kaldi_pitch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;create_fb_matrix&quot;</span><span class="p">,</span>
    <span class="s2">&quot;create_dct&quot;</span><span class="p">,</span>
    <span class="s2">&quot;compute_deltas&quot;</span><span class="p">,</span>
    <span class="s2">&quot;detect_pitch_frequency&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DB_to_amplitude&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mu_law_encoding&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mu_law_decoding&quot;</span><span class="p">,</span>
    <span class="s2">&quot;complex_norm&quot;</span><span class="p">,</span>
    <span class="s2">&quot;angle&quot;</span><span class="p">,</span>
    <span class="s2">&quot;magphase&quot;</span><span class="p">,</span>
    <span class="s2">&quot;phase_vocoder&quot;</span><span class="p">,</span>
    <span class="s1">&#39;mask_along_axis&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mask_along_axis_iid&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sliding_window_cmn&#39;</span><span class="p">,</span>
    <span class="s2">&quot;spectral_centroid&quot;</span><span class="p">,</span>
    <span class="s2">&quot;apply_codec&quot;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="spectrogram"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.spectrogram">[docs]</a><span class="k">def</span> <span class="nf">spectrogram</span><span class="p">(</span>
        <span class="n">waveform</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">pad</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">window</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">n_fft</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">hop_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">win_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">power</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">normalized</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">center</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">pad_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;reflect&quot;</span><span class="p">,</span>
        <span class="n">onesided</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Create a spectrogram or a batch of spectrograms from a raw audio signal.</span>
<span class="sd">    The spectrogram can be either magnitude-only or complex.</span>

<span class="sd">    Args:</span>
<span class="sd">        waveform (Tensor): Tensor of audio of dimension (..., time)</span>
<span class="sd">        pad (int): Two sided padding of signal</span>
<span class="sd">        window (Tensor): Window tensor that is applied/multiplied to each frame/window</span>
<span class="sd">        n_fft (int): Size of FFT</span>
<span class="sd">        hop_length (int): Length of hop between STFT windows</span>
<span class="sd">        win_length (int): Window size</span>
<span class="sd">        power (float or None): Exponent for the magnitude spectrogram,</span>
<span class="sd">            (must be &gt; 0) e.g., 1 for energy, 2 for power, etc.</span>
<span class="sd">            If None, then the complex spectrum is returned instead.</span>
<span class="sd">        normalized (bool): Whether to normalize by magnitude after stft</span>
<span class="sd">        center (bool, optional): whether to pad :attr:`waveform` on both sides so</span>
<span class="sd">            that the :math:`t`-th frame is centered at time :math:`t \times \text{hop\_length}`.</span>
<span class="sd">            Default: ``True``</span>
<span class="sd">        pad_mode (string, optional): controls the padding method used when</span>
<span class="sd">            :attr:`center` is ``True``. Default: ``&quot;reflect&quot;``</span>
<span class="sd">        onesided (bool, optional): controls whether to return half of results to</span>
<span class="sd">            avoid redundancy. Default: ``True``</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Dimension (..., freq, time), freq is</span>
<span class="sd">        ``n_fft // 2 + 1`` and ``n_fft`` is the number of</span>
<span class="sd">        Fourier bins, and time is the number of window hops (n_frame).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">pad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># TODO add &quot;with torch.no_grad():&quot; back when JIT supports it</span>
        <span class="n">waveform</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">waveform</span><span class="p">,</span> <span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">),</span> <span class="s2">&quot;constant&quot;</span><span class="p">)</span>

    <span class="c1"># pack batch</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">waveform</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">waveform</span> <span class="o">=</span> <span class="n">waveform</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># default values are consistent with librosa.core.spectrum._spectrogram</span>
    <span class="n">spec_f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stft</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">waveform</span><span class="p">,</span>
        <span class="n">n_fft</span><span class="o">=</span><span class="n">n_fft</span><span class="p">,</span>
        <span class="n">hop_length</span><span class="o">=</span><span class="n">hop_length</span><span class="p">,</span>
        <span class="n">win_length</span><span class="o">=</span><span class="n">win_length</span><span class="p">,</span>
        <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
        <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span>
        <span class="n">pad_mode</span><span class="o">=</span><span class="n">pad_mode</span><span class="p">,</span>
        <span class="n">normalized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">onesided</span><span class="o">=</span><span class="n">onesided</span><span class="p">,</span>
        <span class="n">return_complex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># unpack batch</span>
    <span class="n">spec_f</span> <span class="o">=</span> <span class="n">spec_f</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">spec_f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>

    <span class="k">if</span> <span class="n">normalized</span><span class="p">:</span>
        <span class="n">spec_f</span> <span class="o">/=</span> <span class="n">window</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">power</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">power</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spec_f</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">spec_f</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">power</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_real</span><span class="p">(</span><span class="n">spec_f</span><span class="p">)</span></div>


<div class="viewcode-block" id="griffinlim"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.griffinlim">[docs]</a><span class="k">def</span> <span class="nf">griffinlim</span><span class="p">(</span>
        <span class="n">specgram</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">window</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">n_fft</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">hop_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">win_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">power</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">normalized</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">n_iter</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">momentum</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">rand_init</span><span class="p">:</span> <span class="nb">bool</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute waveform from a linear scale magnitude spectrogram using the Griffin-Lim transformation.</span>
<span class="sd">        Implementation ported from `librosa`.</span>

<span class="sd">    *  [1] McFee, Brian, Colin Raffel, Dawen Liang, Daniel PW Ellis, Matt McVicar, Eric Battenberg, and Oriol Nieto.</span>
<span class="sd">        &quot;librosa: Audio and music signal analysis in python.&quot;</span>
<span class="sd">        In Proceedings of the 14th python in science conference, pp. 18-25. 2015.</span>
<span class="sd">    *  [2] Perraudin, N., Balazs, P., &amp; Søndergaard, P. L.</span>
<span class="sd">        &quot;A fast Griffin-Lim algorithm,&quot;</span>
<span class="sd">        IEEE Workshop on Applications of Signal Processing to Audio and Acoustics (pp. 1-4),</span>
<span class="sd">        Oct. 2013.</span>
<span class="sd">    *  [3] D. W. Griffin and J. S. Lim,</span>
<span class="sd">        &quot;Signal estimation from modified short-time Fourier transform,&quot;</span>
<span class="sd">        IEEE Trans. ASSP, vol.32, no.2, pp.236–243, Apr. 1984.</span>

<span class="sd">    Args:</span>
<span class="sd">        specgram (Tensor): A magnitude-only STFT spectrogram of dimension (..., freq, frames)</span>
<span class="sd">            where freq is ``n_fft // 2 + 1``.</span>
<span class="sd">        window (Tensor): Window tensor that is applied/multiplied to each frame/window</span>
<span class="sd">        n_fft (int): Size of FFT, creates ``n_fft // 2 + 1`` bins</span>
<span class="sd">        hop_length (int): Length of hop between STFT windows. (</span>
<span class="sd">            Default: ``win_length // 2``)</span>
<span class="sd">        win_length (int): Window size. (Default: ``n_fft``)</span>
<span class="sd">        power (float): Exponent for the magnitude spectrogram,</span>
<span class="sd">            (must be &gt; 0) e.g., 1 for energy, 2 for power, etc.</span>
<span class="sd">        normalized (bool): Whether to normalize by magnitude after stft.</span>
<span class="sd">        n_iter (int): Number of iteration for phase recovery process.</span>
<span class="sd">        momentum (float): The momentum parameter for fast Griffin-Lim.</span>
<span class="sd">            Setting this to 0 recovers the original Griffin-Lim method.</span>
<span class="sd">            Values near 1 can lead to faster convergence, but above 1 may not converge.</span>
<span class="sd">        length (int or None): Array length of the expected output.</span>
<span class="sd">        rand_init (bool): Initializes phase randomly if True, to zero otherwise.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: waveform of (..., time), where time equals the ``length`` parameter if given.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">momentum</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;momentum=</span><span class="si">{}</span><span class="s1"> &gt; 1 can be unstable&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">momentum</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">momentum</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;momentum=</span><span class="si">{}</span><span class="s1"> &lt; 0&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">momentum</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalized</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;The argument normalized is not used in Griffin-Lim, &quot;</span>
            <span class="s2">&quot;and will be removed in v0.9.0 release. To suppress this warning, &quot;</span>
            <span class="s2">&quot;please use `normalized=False`.&quot;</span><span class="p">)</span>

    <span class="c1"># pack batch</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">specgram</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">specgram</span> <span class="o">=</span> <span class="n">specgram</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]))</span>

    <span class="n">specgram</span> <span class="o">=</span> <span class="n">specgram</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">power</span><span class="p">)</span>

    <span class="c1"># randomly initialize the phase</span>
    <span class="n">batch</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">frames</span> <span class="o">=</span> <span class="n">specgram</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rand_init</span><span class="p">:</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">angles</span><span class="o">.</span><span class="n">cos</span><span class="p">(),</span> <span class="n">angles</span><span class="o">.</span><span class="n">sin</span><span class="p">()],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">specgram</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">specgram</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">specgram</span> <span class="o">=</span> <span class="n">specgram</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>

    <span class="c1"># And initialize the previous iterate to 0</span>
    <span class="n">rebuilt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iter</span><span class="p">):</span>
        <span class="c1"># Store the previous iterate</span>
        <span class="n">tprev</span> <span class="o">=</span> <span class="n">rebuilt</span>

        <span class="c1"># Invert with our current estimate of the phases</span>
        <span class="n">inverse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">istft</span><span class="p">(</span><span class="n">specgram</span> <span class="o">*</span> <span class="n">angles</span><span class="p">,</span>
                              <span class="n">n_fft</span><span class="o">=</span><span class="n">n_fft</span><span class="p">,</span>
                              <span class="n">hop_length</span><span class="o">=</span><span class="n">hop_length</span><span class="p">,</span>
                              <span class="n">win_length</span><span class="o">=</span><span class="n">win_length</span><span class="p">,</span>
                              <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
                              <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="c1"># Rebuild the spectrogram</span>
        <span class="n">rebuilt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_real</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">stft</span><span class="p">(</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">inverse</span><span class="p">,</span>
                <span class="n">n_fft</span><span class="o">=</span><span class="n">n_fft</span><span class="p">,</span>
                <span class="n">hop_length</span><span class="o">=</span><span class="n">hop_length</span><span class="p">,</span>
                <span class="n">win_length</span><span class="o">=</span><span class="n">win_length</span><span class="p">,</span>
                <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
                <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">pad_mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span>
                <span class="n">normalized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">onesided</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">return_complex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Update our phase estimates</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">rebuilt</span>
        <span class="k">if</span> <span class="n">momentum</span><span class="p">:</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="n">angles</span> <span class="o">-</span> <span class="n">tprev</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">momentum</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">momentum</span><span class="p">))</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">complex_norm</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mf">1e-16</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">angles</span><span class="p">))</span>

    <span class="c1"># Return the final phase estimates</span>
    <span class="n">waveform</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">istft</span><span class="p">(</span><span class="n">specgram</span> <span class="o">*</span> <span class="n">angles</span><span class="p">,</span>
                           <span class="n">n_fft</span><span class="o">=</span><span class="n">n_fft</span><span class="p">,</span>
                           <span class="n">hop_length</span><span class="o">=</span><span class="n">hop_length</span><span class="p">,</span>
                           <span class="n">win_length</span><span class="o">=</span><span class="n">win_length</span><span class="p">,</span>
                           <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
                           <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">)</span>

    <span class="c1"># unpack batch</span>
    <span class="n">waveform</span> <span class="o">=</span> <span class="n">waveform</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">waveform</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:])</span>

    <span class="k">return</span> <span class="n">waveform</span></div>


<div class="viewcode-block" id="amplitude_to_DB"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.amplitude_to_DB">[docs]</a><span class="k">def</span> <span class="nf">amplitude_to_DB</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">multiplier</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">amin</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">db_multiplier</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">top_db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Turn a spectrogram from the power/amplitude scale to the decibel scale.</span>

<span class="sd">    The output of each tensor in a batch depends on the maximum value of that tensor,</span>
<span class="sd">    and so may return different values for an audio clip split into snippets vs. a full clip.</span>

<span class="sd">    Args:</span>

<span class="sd">        x (Tensor): Input spectrogram(s) before being converted to decibel scale. Input should take</span>
<span class="sd">          the form `(..., freq, time)`. Batched inputs should include a channel dimension and</span>
<span class="sd">          have the form `(batch, channel, freq, time)`.</span>
<span class="sd">        multiplier (float): Use 10. for power and 20. for amplitude</span>
<span class="sd">        amin (float): Number to clamp ``x``</span>
<span class="sd">        db_multiplier (float): Log10(max(reference value and amin))</span>
<span class="sd">        top_db (float or None, optional): Minimum negative cut-off in decibels. A reasonable number</span>
<span class="sd">            is 80. (Default: ``None``)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Output tensor in decibel scale</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_db</span> <span class="o">=</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">amin</span><span class="p">))</span>
    <span class="n">x_db</span> <span class="o">-=</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">db_multiplier</span>

    <span class="k">if</span> <span class="n">top_db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Expand batch</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">x_db</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">packed_channels</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">x_db</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">x_db</span> <span class="o">=</span> <span class="n">x_db</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">packed_channels</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">x_db</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_db</span><span class="p">,</span> <span class="p">(</span><span class="n">x_db</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="n">top_db</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Repack batch</span>
        <span class="n">x_db</span> <span class="o">=</span> <span class="n">x_db</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x_db</span></div>


<div class="viewcode-block" id="DB_to_amplitude"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.DB_to_amplitude">[docs]</a><span class="k">def</span> <span class="nf">DB_to_amplitude</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">ref</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">power</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Turn a tensor from the decibel scale to the power/amplitude scale.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (Tensor): Input tensor before being converted to power/amplitude scale.</span>
<span class="sd">        ref (float): Reference which the output will be scaled by.</span>
<span class="sd">        power (float): If power equals 1, will compute DB to power. If 0.5, will compute DB to amplitude.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Output tensor in power/amplitude scale.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ref</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span> <span class="n">power</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_hz_to_mel</span><span class="p">(</span><span class="n">freq</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mel_scale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;htk&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Convert Hz to Mels.</span>

<span class="sd">    Args:</span>
<span class="sd">        freqs (float): Frequencies in Hz</span>
<span class="sd">        mel_scale (str, optional): Scale to use: ``htk`` or ``slaney``. (Default: ``htk``)</span>

<span class="sd">    Returns:</span>
<span class="sd">        mels (float): Frequency in Mels</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">mel_scale</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;slaney&#39;</span><span class="p">,</span> <span class="s1">&#39;htk&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mel_scale should be one of &quot;htk&quot; or &quot;slaney&quot;.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mel_scale</span> <span class="o">==</span> <span class="s2">&quot;htk&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">2595.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">freq</span> <span class="o">/</span> <span class="mf">700.0</span><span class="p">))</span>

    <span class="c1"># Fill in the linear part</span>
    <span class="n">f_min</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">f_sp</span> <span class="o">=</span> <span class="mf">200.0</span> <span class="o">/</span> <span class="mi">3</span>

    <span class="n">mels</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">-</span> <span class="n">f_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">f_sp</span>

    <span class="c1"># Fill in the log-scale part</span>
    <span class="n">min_log_hz</span> <span class="o">=</span> <span class="mf">1000.0</span>
    <span class="n">min_log_mel</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_log_hz</span> <span class="o">-</span> <span class="n">f_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">f_sp</span>
    <span class="n">logstep</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">6.4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">27.0</span>

    <span class="k">if</span> <span class="n">freq</span> <span class="o">&gt;=</span> <span class="n">min_log_hz</span><span class="p">:</span>
        <span class="n">mels</span> <span class="o">=</span> <span class="n">min_log_mel</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">freq</span> <span class="o">/</span> <span class="n">min_log_hz</span><span class="p">)</span> <span class="o">/</span> <span class="n">logstep</span>

    <span class="k">return</span> <span class="n">mels</span>


<span class="k">def</span> <span class="nf">_mel_to_hz</span><span class="p">(</span><span class="n">mels</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">mel_scale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;htk&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert mel bin numbers to frequencies.</span>

<span class="sd">    Args:</span>
<span class="sd">        mels (Tensor): Mel frequencies</span>
<span class="sd">        mel_scale (str, optional): Scale to use: ``htk`` or ``slaney``. (Default: ``htk``)</span>

<span class="sd">    Returns:</span>
<span class="sd">        freqs (Tensor): Mels converted in Hz</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">mel_scale</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;slaney&#39;</span><span class="p">,</span> <span class="s1">&#39;htk&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mel_scale should be one of &quot;htk&quot; or &quot;slaney&quot;.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mel_scale</span> <span class="o">==</span> <span class="s2">&quot;htk&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">700.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="n">mels</span> <span class="o">/</span> <span class="mf">2595.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># Fill in the linear scale</span>
    <span class="n">f_min</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">f_sp</span> <span class="o">=</span> <span class="mf">200.0</span> <span class="o">/</span> <span class="mi">3</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">f_min</span> <span class="o">+</span> <span class="n">f_sp</span> <span class="o">*</span> <span class="n">mels</span>

    <span class="c1"># And now the nonlinear scale</span>
    <span class="n">min_log_hz</span> <span class="o">=</span> <span class="mf">1000.0</span>
    <span class="n">min_log_mel</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_log_hz</span> <span class="o">-</span> <span class="n">f_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">f_sp</span>
    <span class="n">logstep</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">6.4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">27.0</span>

    <span class="n">log_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">mels</span> <span class="o">&gt;=</span> <span class="n">min_log_mel</span><span class="p">)</span>
    <span class="n">freqs</span><span class="p">[</span><span class="n">log_t</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_log_hz</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logstep</span> <span class="o">*</span> <span class="p">(</span><span class="n">mels</span><span class="p">[</span><span class="n">log_t</span><span class="p">]</span> <span class="o">-</span> <span class="n">min_log_mel</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">freqs</span>


<div class="viewcode-block" id="create_fb_matrix"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.create_fb_matrix">[docs]</a><span class="k">def</span> <span class="nf">create_fb_matrix</span><span class="p">(</span>
        <span class="n">n_freqs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">f_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">f_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">n_mels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">norm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mel_scale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;htk&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Create a frequency bin conversion matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_freqs (int): Number of frequencies to highlight/apply</span>
<span class="sd">        f_min (float): Minimum frequency (Hz)</span>
<span class="sd">        f_max (float): Maximum frequency (Hz)</span>
<span class="sd">        n_mels (int): Number of mel filterbanks</span>
<span class="sd">        sample_rate (int): Sample rate of the audio waveform</span>
<span class="sd">        norm (Optional[str]): If &#39;slaney&#39;, divide the triangular mel weights by the width of the mel band</span>
<span class="sd">        (area normalization). (Default: ``None``)</span>
<span class="sd">        mel_scale (str, optional): Scale to use: ``htk`` or ``slaney``. (Default: ``htk``)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Triangular filter banks (fb matrix) of size (``n_freqs``, ``n_mels``)</span>
<span class="sd">        meaning number of frequencies to highlight/apply to x the number of filterbanks.</span>
<span class="sd">        Each column is a filterbank so that assuming there is a matrix A of</span>
<span class="sd">        size (..., ``n_freqs``), the applied result would be</span>
<span class="sd">        ``A * create_fb_matrix(A.size(-1), ...)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">norm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">norm</span> <span class="o">!=</span> <span class="s2">&quot;slaney&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;norm must be one of None or &#39;slaney&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># freq bins</span>
    <span class="c1"># Equivalent filterbank construction by Librosa</span>
    <span class="n">all_freqs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sample_rate</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_freqs</span><span class="p">)</span>

    <span class="c1"># calculate mel freq bins</span>
    <span class="n">m_min</span> <span class="o">=</span> <span class="n">_hz_to_mel</span><span class="p">(</span><span class="n">f_min</span><span class="p">,</span> <span class="n">mel_scale</span><span class="o">=</span><span class="n">mel_scale</span><span class="p">)</span>
    <span class="n">m_max</span> <span class="o">=</span> <span class="n">_hz_to_mel</span><span class="p">(</span><span class="n">f_max</span><span class="p">,</span> <span class="n">mel_scale</span><span class="o">=</span><span class="n">mel_scale</span><span class="p">)</span>

    <span class="n">m_pts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">m_min</span><span class="p">,</span> <span class="n">m_max</span><span class="p">,</span> <span class="n">n_mels</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">f_pts</span> <span class="o">=</span> <span class="n">_mel_to_hz</span><span class="p">(</span><span class="n">m_pts</span><span class="p">,</span> <span class="n">mel_scale</span><span class="o">=</span><span class="n">mel_scale</span><span class="p">)</span>

    <span class="c1"># calculate the difference between each mel point and each stft freq point in hertz</span>
    <span class="n">f_diff</span> <span class="o">=</span> <span class="n">f_pts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">f_pts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># (n_mels + 1)</span>
    <span class="n">slopes</span> <span class="o">=</span> <span class="n">f_pts</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">all_freqs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (n_freqs, n_mels + 2)</span>
    <span class="c1"># create overlapping triangles</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">down_slopes</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">slopes</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">f_diff</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># (n_freqs, n_mels)</span>
    <span class="n">up_slopes</span> <span class="o">=</span> <span class="n">slopes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">/</span> <span class="n">f_diff</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># (n_freqs, n_mels)</span>
    <span class="n">fb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">zero</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">down_slopes</span><span class="p">,</span> <span class="n">up_slopes</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">norm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">norm</span> <span class="o">==</span> <span class="s2">&quot;slaney&quot;</span><span class="p">:</span>
        <span class="c1"># Slaney-style mel is scaled to be approx constant energy per channel</span>
        <span class="n">enorm</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">f_pts</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">n_mels</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">f_pts</span><span class="p">[:</span><span class="n">n_mels</span><span class="p">])</span>
        <span class="n">fb</span> <span class="o">*=</span> <span class="n">enorm</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;At least one mel filterbank has all zero values. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;The value for `n_mels` (</span><span class="si">{</span><span class="n">n_mels</span><span class="si">}</span><span class="s2">) may be set too high. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Or, the value for `n_freqs` (</span><span class="si">{</span><span class="n">n_freqs</span><span class="si">}</span><span class="s2">) may be set too low.&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">fb</span></div>


<div class="viewcode-block" id="create_dct"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.create_dct">[docs]</a><span class="k">def</span> <span class="nf">create_dct</span><span class="p">(</span>
        <span class="n">n_mfcc</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_mels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">norm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Create a DCT transformation matrix with shape (``n_mels``, ``n_mfcc``),</span>
<span class="sd">    normalized depending on norm.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_mfcc (int): Number of mfc coefficients to retain</span>
<span class="sd">        n_mels (int): Number of mel filterbanks</span>
<span class="sd">        norm (str or None): Norm to use (either &#39;ortho&#39; or None)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: The transformation matrix, to be right-multiplied to</span>
<span class="sd">        row-wise data of size (``n_mels``, ``n_mfcc``).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># http://en.wikipedia.org/wiki/Discrete_cosine_transform#DCT-II</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n_mels</span><span class="p">))</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n_mfcc</span><span class="p">))</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dct</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_mels</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span>  <span class="c1"># size (n_mfcc, n_mels)</span>
    <span class="k">if</span> <span class="n">norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dct</span> <span class="o">*=</span> <span class="mf">2.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">norm</span> <span class="o">==</span> <span class="s2">&quot;ortho&quot;</span>
        <span class="n">dct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">dct</span> <span class="o">*=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_mels</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dct</span><span class="o">.</span><span class="n">t</span><span class="p">()</span></div>


<div class="viewcode-block" id="mu_law_encoding"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.mu_law_encoding">[docs]</a><span class="k">def</span> <span class="nf">mu_law_encoding</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">quantization_channels</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Encode signal based on mu-law companding.  For more info see the</span>
<span class="sd">    `Wikipedia Entry &lt;https://en.wikipedia.org/wiki/%CE%9C-law_algorithm&gt;`_</span>

<span class="sd">    This algorithm assumes the signal has been scaled to between -1 and 1 and</span>
<span class="sd">    returns a signal encoded with values from 0 to quantization_channels - 1.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (Tensor): Input tensor</span>
<span class="sd">        quantization_channels (int): Number of channels</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Input after mu-law encoding</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">quantization_channels</span> <span class="o">-</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">is_floating_point</span><span class="p">():</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">x_mu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">mu</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">x_mu</span> <span class="o">=</span> <span class="p">((</span><span class="n">x_mu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_mu</span></div>


<div class="viewcode-block" id="mu_law_decoding"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.mu_law_decoding">[docs]</a><span class="k">def</span> <span class="nf">mu_law_decoding</span><span class="p">(</span>
        <span class="n">x_mu</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">quantization_channels</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Decode mu-law encoded signal.  For more info see the</span>
<span class="sd">    `Wikipedia Entry &lt;https://en.wikipedia.org/wiki/%CE%9C-law_algorithm&gt;`_</span>

<span class="sd">    This expects an input with values between 0 and quantization_channels - 1</span>
<span class="sd">    and returns a signal scaled between -1 and 1.</span>

<span class="sd">    Args:</span>
<span class="sd">        x_mu (Tensor): Input tensor</span>
<span class="sd">        quantization_channels (int): Number of channels</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Input after mu-law decoding</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">quantization_channels</span> <span class="o">-</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">x_mu</span><span class="o">.</span><span class="n">is_floating_point</span><span class="p">():</span>
        <span class="n">x_mu</span> <span class="o">=</span> <span class="n">x_mu</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x_mu</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">x_mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">mu</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">1.0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">mu</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="complex_norm"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.complex_norm">[docs]</a><span class="k">def</span> <span class="nf">complex_norm</span><span class="p">(</span>
        <span class="n">complex_tensor</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">power</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute the norm of complex tensor input.</span>

<span class="sd">    Args:</span>
<span class="sd">        complex_tensor (Tensor): Tensor shape of `(..., complex=2)`</span>
<span class="sd">        power (float): Power of the norm. (Default: `1.0`).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Power of the normed input tensor. Shape of `(..., )`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Replace by torch.norm once issue is fixed</span>
    <span class="c1"># https://github.com/pytorch/pytorch/issues/34279</span>
    <span class="k">return</span> <span class="n">complex_tensor</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">power</span><span class="p">)</span></div>


<div class="viewcode-block" id="angle"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.angle">[docs]</a><span class="k">def</span> <span class="nf">angle</span><span class="p">(</span>
        <span class="n">complex_tensor</span><span class="p">:</span> <span class="n">Tensor</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute the angle of complex tensor input.</span>

<span class="sd">    Args:</span>
<span class="sd">        complex_tensor (Tensor): Tensor shape of `(..., complex=2)`</span>

<span class="sd">    Return:</span>
<span class="sd">        Tensor: Angle of a complex tensor. Shape of `(..., )`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">complex_tensor</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">complex_tensor</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="magphase"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.magphase">[docs]</a><span class="k">def</span> <span class="nf">magphase</span><span class="p">(</span>
        <span class="n">complex_tensor</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">power</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Separate a complex-valued spectrogram with shape `(..., 2)` into its magnitude and phase.</span>

<span class="sd">    Args:</span>
<span class="sd">        complex_tensor (Tensor): Tensor shape of `(..., complex=2)`</span>
<span class="sd">        power (float): Power of the norm. (Default: `1.0`)</span>

<span class="sd">    Returns:</span>
<span class="sd">        (Tensor, Tensor): The magnitude and phase of the complex tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="n">complex_norm</span><span class="p">(</span><span class="n">complex_tensor</span><span class="p">,</span> <span class="n">power</span><span class="p">)</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">angle</span><span class="p">(</span><span class="n">complex_tensor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mag</span><span class="p">,</span> <span class="n">phase</span></div>


<div class="viewcode-block" id="phase_vocoder"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.phase_vocoder">[docs]</a><span class="k">def</span> <span class="nf">phase_vocoder</span><span class="p">(</span>
        <span class="n">complex_specgrams</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">phase_advance</span><span class="p">:</span> <span class="n">Tensor</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Given a STFT tensor, speed up in time without modifying pitch by a</span>
<span class="sd">    factor of ``rate``.</span>

<span class="sd">    Args:</span>
<span class="sd">        complex_specgrams (Tensor): Dimension of `(..., freq, time, complex=2)`</span>
<span class="sd">        rate (float): Speed-up factor</span>
<span class="sd">        phase_advance (Tensor): Expected phase advance in each bin. Dimension of (freq, 1)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Complex Specgrams Stretch with dimension of `(..., freq, ceil(time/rate), complex=2)`</span>

<span class="sd">    Example</span>
<span class="sd">        &gt;&gt;&gt; freq, hop_length = 1025, 512</span>
<span class="sd">        &gt;&gt;&gt; # (channel, freq, time, complex=2)</span>
<span class="sd">        &gt;&gt;&gt; complex_specgrams = torch.randn(2, freq, 300, 2)</span>
<span class="sd">        &gt;&gt;&gt; rate = 1.3 # Speed up by 30%</span>
<span class="sd">        &gt;&gt;&gt; phase_advance = torch.linspace(</span>
<span class="sd">        &gt;&gt;&gt;    0, math.pi * hop_length, freq)[..., None]</span>
<span class="sd">        &gt;&gt;&gt; x = phase_vocoder(complex_specgrams, rate, phase_advance)</span>
<span class="sd">        &gt;&gt;&gt; x.shape # with 231 == ceil(300 / 1.3)</span>
<span class="sd">        torch.Size([2, 1025, 231, 2])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># pack batch</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">complex_specgrams</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">complex_specgrams</span> <span class="o">=</span> <span class="n">complex_specgrams</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]))</span>

    <span class="n">time_steps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                              <span class="n">complex_specgrams</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span>
                              <span class="n">rate</span><span class="p">,</span>
                              <span class="n">device</span><span class="o">=</span><span class="n">complex_specgrams</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                              <span class="n">dtype</span><span class="o">=</span><span class="n">complex_specgrams</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">alphas</span> <span class="o">=</span> <span class="n">time_steps</span> <span class="o">%</span> <span class="mf">1.0</span>
    <span class="n">phase_0</span> <span class="o">=</span> <span class="n">angle</span><span class="p">(</span><span class="n">complex_specgrams</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

    <span class="c1"># Time Padding</span>
    <span class="n">complex_specgrams</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">complex_specgrams</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

    <span class="c1"># (new_bins, freq, 2)</span>
    <span class="n">complex_specgrams_0</span> <span class="o">=</span> <span class="n">complex_specgrams</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">time_steps</span><span class="o">.</span><span class="n">long</span><span class="p">())</span>
    <span class="n">complex_specgrams_1</span> <span class="o">=</span> <span class="n">complex_specgrams</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">time_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">())</span>

    <span class="n">angle_0</span> <span class="o">=</span> <span class="n">angle</span><span class="p">(</span><span class="n">complex_specgrams_0</span><span class="p">)</span>
    <span class="n">angle_1</span> <span class="o">=</span> <span class="n">angle</span><span class="p">(</span><span class="n">complex_specgrams_1</span><span class="p">)</span>

    <span class="n">norm_0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">complex_specgrams_0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">norm_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">complex_specgrams_1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">phase</span> <span class="o">=</span> <span class="n">angle_1</span> <span class="o">-</span> <span class="n">angle_0</span> <span class="o">-</span> <span class="n">phase_advance</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">phase</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

    <span class="c1"># Compute Phase Accum</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">+</span> <span class="n">phase_advance</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">phase_0</span><span class="p">,</span> <span class="n">phase</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">phase_acc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">mag</span> <span class="o">=</span> <span class="n">alphas</span> <span class="o">*</span> <span class="n">norm_1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alphas</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm_0</span>

    <span class="n">real_stretch</span> <span class="o">=</span> <span class="n">mag</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase_acc</span><span class="p">)</span>
    <span class="n">imag_stretch</span> <span class="o">=</span> <span class="n">mag</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase_acc</span><span class="p">)</span>

    <span class="n">complex_specgrams_stretch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">real_stretch</span><span class="p">,</span> <span class="n">imag_stretch</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># unpack batch</span>
    <span class="n">complex_specgrams_stretch</span> <span class="o">=</span> <span class="n">complex_specgrams_stretch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">complex_specgrams_stretch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="k">return</span> <span class="n">complex_specgrams_stretch</span></div>


<div class="viewcode-block" id="mask_along_axis_iid"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.mask_along_axis_iid">[docs]</a><span class="k">def</span> <span class="nf">mask_along_axis_iid</span><span class="p">(</span>
        <span class="n">specgrams</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">mask_param</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">mask_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a mask along ``axis``. Mask will be applied from indices ``[v_0, v_0 + v)``, where</span>
<span class="sd">    ``v`` is sampled from ``uniform(0, mask_param)``, and ``v_0`` from ``uniform(0, max_v - v)``.</span>

<span class="sd">    Args:</span>
<span class="sd">        specgrams (Tensor): Real spectrograms (batch, channel, freq, time)</span>
<span class="sd">        mask_param (int): Number of columns to be masked will be uniformly sampled from [0, mask_param]</span>
<span class="sd">        mask_value (float): Value to assign to the masked columns</span>
<span class="sd">        axis (int): Axis to apply masking on (2 -&gt; frequency, 3 -&gt; time)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Masked spectrograms of dimensions (batch, channel, freq, time)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">axis</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">axis</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only Frequency and Time masking are supported&#39;</span><span class="p">)</span>

    <span class="n">device</span> <span class="o">=</span> <span class="n">specgrams</span><span class="o">.</span><span class="n">device</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">specgrams</span><span class="o">.</span><span class="n">dtype</span>

    <span class="n">value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">specgrams</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask_param</span>
    <span class="n">min_value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">specgrams</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">specgrams</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">-</span> <span class="n">value</span><span class="p">)</span>

    <span class="c1"># Create broadcastable mask</span>
    <span class="n">mask_start</span> <span class="o">=</span> <span class="n">min_value</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">mask_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_value</span> <span class="o">+</span> <span class="n">value</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">specgrams</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">axis</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="c1"># Per batch example masking</span>
    <span class="n">specgrams</span> <span class="o">=</span> <span class="n">specgrams</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">specgrams</span><span class="o">.</span><span class="n">masked_fill_</span><span class="p">((</span><span class="n">mask</span> <span class="o">&gt;=</span> <span class="n">mask_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&lt;</span> <span class="n">mask_end</span><span class="p">),</span> <span class="n">mask_value</span><span class="p">)</span>
    <span class="n">specgrams</span> <span class="o">=</span> <span class="n">specgrams</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">specgrams</span></div>


<div class="viewcode-block" id="mask_along_axis"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.mask_along_axis">[docs]</a><span class="k">def</span> <span class="nf">mask_along_axis</span><span class="p">(</span>
        <span class="n">specgram</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">mask_param</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">mask_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a mask along ``axis``. Mask will be applied from indices ``[v_0, v_0 + v)``, where</span>
<span class="sd">    ``v`` is sampled from ``uniform(0, mask_param)``, and ``v_0`` from ``uniform(0, max_v - v)``.</span>
<span class="sd">    All examples will have the same mask interval.</span>

<span class="sd">    Args:</span>
<span class="sd">        specgram (Tensor): Real spectrogram (channel, freq, time)</span>
<span class="sd">        mask_param (int): Number of columns to be masked will be uniformly sampled from [0, mask_param]</span>
<span class="sd">        mask_value (float): Value to assign to the masked columns</span>
<span class="sd">        axis (int): Axis to apply masking on (1 -&gt; frequency, 2 -&gt; time)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Masked spectrogram of dimensions (channel, freq, time)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># pack batch</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">specgram</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">specgram</span> <span class="o">=</span> <span class="n">specgram</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]))</span>

    <span class="n">value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask_param</span>
    <span class="n">min_value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">specgram</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">-</span> <span class="n">value</span><span class="p">)</span>

    <span class="n">mask_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_value</span><span class="o">.</span><span class="n">long</span><span class="p">())</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">mask_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_value</span><span class="o">.</span><span class="n">long</span><span class="p">()</span> <span class="o">+</span> <span class="n">value</span><span class="o">.</span><span class="n">long</span><span class="p">())</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">mask_end</span> <span class="o">-</span> <span class="n">mask_start</span> <span class="o">&lt;</span> <span class="n">mask_param</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">specgram</span><span class="p">[:,</span> <span class="n">mask_start</span><span class="p">:</span><span class="n">mask_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_value</span>
    <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">specgram</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">mask_start</span><span class="p">:</span><span class="n">mask_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only Frequency and Time masking are supported&#39;</span><span class="p">)</span>

    <span class="c1"># unpack batch</span>
    <span class="n">specgram</span> <span class="o">=</span> <span class="n">specgram</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">specgram</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>

    <span class="k">return</span> <span class="n">specgram</span></div>


<div class="viewcode-block" id="compute_deltas"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.compute_deltas">[docs]</a><span class="k">def</span> <span class="nf">compute_deltas</span><span class="p">(</span>
        <span class="n">specgram</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">win_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;replicate&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute delta coefficients of a tensor, usually a spectrogram:</span>

<span class="sd">    .. math::</span>
<span class="sd">       d_t = \frac{\sum_{n=1}^{\text{N}} n (c_{t+n} - c_{t-n})}{2 \sum_{n=1}^{\text{N}} n^2}</span>

<span class="sd">    where :math:`d_t` is the deltas at time :math:`t`,</span>
<span class="sd">    :math:`c_t` is the spectrogram coeffcients at time :math:`t`,</span>
<span class="sd">    :math:`N` is ``(win_length-1)//2``.</span>

<span class="sd">    Args:</span>
<span class="sd">        specgram (Tensor): Tensor of audio of dimension (..., freq, time)</span>
<span class="sd">        win_length (int, optional): The window length used for computing delta (Default: ``5``)</span>
<span class="sd">        mode (str, optional): Mode parameter passed to padding (Default: ``&quot;replicate&quot;``)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Tensor of deltas of dimension (..., freq, time)</span>

<span class="sd">    Example</span>
<span class="sd">        &gt;&gt;&gt; specgram = torch.randn(1, 40, 1000)</span>
<span class="sd">        &gt;&gt;&gt; delta = compute_deltas(specgram)</span>
<span class="sd">        &gt;&gt;&gt; delta2 = compute_deltas(delta)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">specgram</span><span class="o">.</span><span class="n">device</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">specgram</span><span class="o">.</span><span class="n">dtype</span>

    <span class="c1"># pack batch</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">specgram</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">specgram</span> <span class="o">=</span> <span class="n">specgram</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">assert</span> <span class="n">win_length</span> <span class="o">&gt;=</span> <span class="mi">3</span>

    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">win_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="c1"># twice sum of integer squared</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>

    <span class="n">specgram</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">specgram</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">specgram</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">conv1d</span><span class="p">(</span><span class="n">specgram</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">specgram</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">denom</span>

    <span class="c1"># unpack batch</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span></div>


<span class="k">def</span> <span class="nf">_compute_nccf</span><span class="p">(</span>
        <span class="n">waveform</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">frame_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">freq_low</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Normalized Cross-Correlation Function (NCCF).</span>

<span class="sd">    .. math::</span>
<span class="sd">        \phi_i(m) = \frac{\sum_{n=b_i}^{b_i + N-1} w(n) w(m+n)}{\sqrt{E(b_i) E(m+b_i)}},</span>

<span class="sd">    where</span>
<span class="sd">    :math:`\phi_i(m)` is the NCCF at frame :math:`i` with lag :math:`m`,</span>
<span class="sd">    :math:`w` is the waveform,</span>
<span class="sd">    :math:`N` is the length of a frame,</span>
<span class="sd">    :math:`b_i` is the beginning of frame :math:`i`,</span>
<span class="sd">    :math:`E(j)` is the energy :math:`\sum_{n=j}^{j+N-1} w^2(n)`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">EPSILON</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">9</span><span class="p">)</span>

    <span class="c1"># Number of lags to check</span>
    <span class="n">lags</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">sample_rate</span> <span class="o">/</span> <span class="n">freq_low</span><span class="p">))</span>

    <span class="n">frame_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">sample_rate</span> <span class="o">*</span> <span class="n">frame_time</span><span class="p">))</span>

    <span class="n">waveform_length</span> <span class="o">=</span> <span class="n">waveform</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">num_of_frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">waveform_length</span> <span class="o">/</span> <span class="n">frame_size</span><span class="p">))</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">lags</span> <span class="o">+</span> <span class="n">num_of_frames</span> <span class="o">*</span> <span class="n">frame_size</span> <span class="o">-</span> <span class="n">waveform_length</span>
    <span class="n">waveform</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">waveform</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

    <span class="c1"># Compute lags</span>
    <span class="n">output_lag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">waveform</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="n">lag</span><span class="p">]</span><span class="o">.</span><span class="n">unfold</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">frame_size</span><span class="p">,</span> <span class="n">frame_size</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">num_of_frames</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">waveform</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">lag</span><span class="p">:]</span><span class="o">.</span><span class="n">unfold</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">frame_size</span><span class="p">,</span> <span class="n">frame_size</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">num_of_frames</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">output_frames</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">s1</span> <span class="o">*</span> <span class="n">s2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">EPSILON</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">EPSILON</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">output_lag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_frames</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">nccf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">output_lag</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nccf</span>


<span class="k">def</span> <span class="nf">_combine_max</span><span class="p">(</span>
        <span class="n">a</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="n">b</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="n">thresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take value from first if bigger than a multiplicative factor of the second, elementwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">thresh</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="o">~</span><span class="n">mask</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="o">~</span><span class="n">mask</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">values</span><span class="p">,</span> <span class="n">indices</span>


<span class="k">def</span> <span class="nf">_find_max_per_frame</span><span class="p">(</span>
        <span class="n">nccf</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">freq_high</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each frame, take the highest value of NCCF,</span>
<span class="sd">    apply centered median smoothing, and convert to frequency.</span>

<span class="sd">    Note: If the max among all the lags is very close</span>
<span class="sd">    to the first half of lags, then the latter is taken.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lag_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">sample_rate</span> <span class="o">/</span> <span class="n">freq_high</span><span class="p">))</span>

    <span class="c1"># Find near enough max that is smallest</span>

    <span class="n">best</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nccf</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">lag_min</span><span class="p">:],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">half_size</span> <span class="o">=</span> <span class="n">nccf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">half</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nccf</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">lag_min</span><span class="p">:</span><span class="n">half_size</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">best</span> <span class="o">=</span> <span class="n">_combine_max</span><span class="p">(</span><span class="n">half</span><span class="p">,</span> <span class="n">best</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">best</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Add back minimal lag</span>
    <span class="n">indices</span> <span class="o">+=</span> <span class="n">lag_min</span>
    <span class="c1"># Add 1 empirical calibration offset</span>
    <span class="n">indices</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">indices</span>


<span class="k">def</span> <span class="nf">_median_smoothing</span><span class="p">(</span>
        <span class="n">indices</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">win_length</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply median smoothing to the 1D tensor over the given window.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Centered windowed</span>
    <span class="n">pad_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">win_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="c1"># &quot;replicate&quot; padding in any dimension</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
        <span class="n">indices</span><span class="p">,</span> <span class="p">(</span><span class="n">pad_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.</span>
    <span class="p">)</span>

    <span class="n">indices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">pad_length</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">pad_length</span> <span class="o">*</span> <span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">pad_length</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">roll</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">unfold</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">win_length</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">values</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">roll</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">values</span>


<div class="viewcode-block" id="detect_pitch_frequency"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.detect_pitch_frequency">[docs]</a><span class="k">def</span> <span class="nf">detect_pitch_frequency</span><span class="p">(</span>
        <span class="n">waveform</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">frame_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">win_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">freq_low</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">85</span><span class="p">,</span>
        <span class="n">freq_high</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3400</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Detect pitch frequency.</span>

<span class="sd">    It is implemented using normalized cross-correlation function and median smoothing.</span>

<span class="sd">    Args:</span>
<span class="sd">        waveform (Tensor): Tensor of audio of dimension (..., freq, time)</span>
<span class="sd">        sample_rate (int): The sample rate of the waveform (Hz)</span>
<span class="sd">        frame_time (float, optional): Duration of a frame (Default: ``10 ** (-2)``).</span>
<span class="sd">        win_length (int, optional): The window length for median smoothing (in number of frames) (Default: ``30``).</span>
<span class="sd">        freq_low (int, optional): Lowest frequency that can be detected (Hz) (Default: ``85``).</span>
<span class="sd">        freq_high (int, optional): Highest frequency that can be detected (Hz) (Default: ``3400``).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Tensor of freq of dimension (..., frame)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pack batch</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">waveform</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
    <span class="n">waveform</span> <span class="o">=</span> <span class="n">waveform</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:])</span>

    <span class="n">nccf</span> <span class="o">=</span> <span class="n">_compute_nccf</span><span class="p">(</span><span class="n">waveform</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">frame_time</span><span class="p">,</span> <span class="n">freq_low</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">_find_max_per_frame</span><span class="p">(</span><span class="n">nccf</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">freq_high</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">_median_smoothing</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">win_length</span><span class="p">)</span>

    <span class="c1"># Convert indices to frequency</span>
    <span class="n">EPSILON</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">sample_rate</span> <span class="o">/</span> <span class="p">(</span><span class="n">EPSILON</span> <span class="o">+</span> <span class="n">indices</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>

    <span class="c1"># unpack batch</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">freq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]))</span>

    <span class="k">return</span> <span class="n">freq</span></div>


<div class="viewcode-block" id="sliding_window_cmn"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.sliding_window_cmn">[docs]</a><span class="k">def</span> <span class="nf">sliding_window_cmn</span><span class="p">(</span>
    <span class="n">waveform</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
    <span class="n">cmn_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
    <span class="n">min_cmn_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">center</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">norm_vars</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply sliding-window cepstral mean (and optionally variance) normalization per utterance.</span>

<span class="sd">    Args:</span>
<span class="sd">        waveform (Tensor): Tensor of audio of dimension (..., freq, time)</span>
<span class="sd">        cmn_window (int, optional): Window in frames for running average CMN computation (int, default = 600)</span>
<span class="sd">        min_cmn_window (int, optional):  Minimum CMN window used at start of decoding (adds latency only at start).</span>
<span class="sd">            Only applicable if center == false, ignored if center==true (int, default = 100)</span>
<span class="sd">        center (bool, optional): If true, use a window centered on the current frame</span>
<span class="sd">            (to the extent possible, modulo end effects). If false, window is to the left. (bool, default = false)</span>
<span class="sd">        norm_vars (bool, optional): If true, normalize variance to one. (bool, default = false)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Tensor of freq of dimension (..., frame)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_shape</span> <span class="o">=</span> <span class="n">waveform</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">num_frames</span><span class="p">,</span> <span class="n">num_feats</span> <span class="o">=</span> <span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">waveform</span> <span class="o">=</span> <span class="n">waveform</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_frames</span><span class="p">,</span> <span class="n">num_feats</span><span class="p">)</span>
    <span class="n">num_channels</span> <span class="o">=</span> <span class="n">waveform</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="n">waveform</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">waveform</span><span class="o">.</span><span class="n">device</span>
    <span class="n">last_window_start</span> <span class="o">=</span> <span class="n">last_window_end</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">cur_sum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">num_feats</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">cur_sumsq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">num_feats</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">cmn_waveform</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
        <span class="n">num_channels</span><span class="p">,</span> <span class="n">num_frames</span><span class="p">,</span> <span class="n">num_feats</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_frames</span><span class="p">):</span>
        <span class="n">window_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">window_end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
            <span class="n">window_start</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">cmn_window</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">window_end</span> <span class="o">=</span> <span class="n">window_start</span> <span class="o">+</span> <span class="n">cmn_window</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">window_start</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">cmn_window</span>
            <span class="n">window_end</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">window_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">window_end</span> <span class="o">-=</span> <span class="n">window_start</span>
            <span class="n">window_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">center</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">window_end</span> <span class="o">&gt;</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">window_end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">min_cmn_window</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">window_end</span> <span class="o">&gt;</span> <span class="n">num_frames</span><span class="p">:</span>
            <span class="n">window_start</span> <span class="o">-=</span> <span class="p">(</span><span class="n">window_end</span> <span class="o">-</span> <span class="n">num_frames</span><span class="p">)</span>
            <span class="n">window_end</span> <span class="o">=</span> <span class="n">num_frames</span>
            <span class="k">if</span> <span class="n">window_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">window_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">last_window_start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">input_part</span> <span class="o">=</span> <span class="n">waveform</span><span class="p">[:,</span> <span class="n">window_start</span><span class="p">:</span> <span class="n">window_end</span> <span class="o">-</span> <span class="n">window_start</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">cur_sum</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">input_part</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">norm_vars</span><span class="p">:</span>
                <span class="n">cur_sumsq</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">input_part</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">window_start</span> <span class="o">&gt;</span> <span class="n">last_window_start</span><span class="p">:</span>
                <span class="n">frame_to_remove</span> <span class="o">=</span> <span class="n">waveform</span><span class="p">[:,</span> <span class="n">last_window_start</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">cur_sum</span> <span class="o">-=</span> <span class="n">frame_to_remove</span>
                <span class="k">if</span> <span class="n">norm_vars</span><span class="p">:</span>
                    <span class="n">cur_sumsq</span> <span class="o">-=</span> <span class="p">(</span><span class="n">frame_to_remove</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">window_end</span> <span class="o">&gt;</span> <span class="n">last_window_end</span><span class="p">:</span>
                <span class="n">frame_to_add</span> <span class="o">=</span> <span class="n">waveform</span><span class="p">[:,</span> <span class="n">last_window_end</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">cur_sum</span> <span class="o">+=</span> <span class="n">frame_to_add</span>
                <span class="k">if</span> <span class="n">norm_vars</span><span class="p">:</span>
                    <span class="n">cur_sumsq</span> <span class="o">+=</span> <span class="p">(</span><span class="n">frame_to_add</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">window_frames</span> <span class="o">=</span> <span class="n">window_end</span> <span class="o">-</span> <span class="n">window_start</span>
        <span class="n">last_window_start</span> <span class="o">=</span> <span class="n">window_start</span>
        <span class="n">last_window_end</span> <span class="o">=</span> <span class="n">window_end</span>
        <span class="n">cmn_waveform</span><span class="p">[:,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">waveform</span><span class="p">[:,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">cur_sum</span> <span class="o">/</span> <span class="n">window_frames</span>
        <span class="k">if</span> <span class="n">norm_vars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">window_frames</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cmn_waveform</span><span class="p">[:,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                    <span class="n">num_channels</span><span class="p">,</span> <span class="n">num_feats</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">variance</span> <span class="o">=</span> <span class="n">cur_sumsq</span>
                <span class="n">variance</span> <span class="o">=</span> <span class="n">variance</span> <span class="o">/</span> <span class="n">window_frames</span>
                <span class="n">variance</span> <span class="o">-=</span> <span class="p">((</span><span class="n">cur_sum</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">window_frames</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">variance</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">variance</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">cmn_waveform</span><span class="p">[:,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">variance</span>

    <span class="n">cmn_waveform</span> <span class="o">=</span> <span class="n">cmn_waveform</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_frames</span><span class="p">,</span> <span class="n">num_feats</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">cmn_waveform</span> <span class="o">=</span> <span class="n">cmn_waveform</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cmn_waveform</span></div>


<div class="viewcode-block" id="spectral_centroid"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.spectral_centroid">[docs]</a><span class="k">def</span> <span class="nf">spectral_centroid</span><span class="p">(</span>
        <span class="n">waveform</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">pad</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">window</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">n_fft</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">hop_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">win_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the spectral centroid for each channel along the time axis.</span>

<span class="sd">    The spectral centroid is defined as the weighted average of the</span>
<span class="sd">    frequency values, weighted by their magnitude.</span>

<span class="sd">    Args:</span>
<span class="sd">        waveform (Tensor): Tensor of audio of dimension (..., time)</span>
<span class="sd">        sample_rate (int): Sample rate of the audio waveform</span>
<span class="sd">        pad (int): Two sided padding of signal</span>
<span class="sd">        window (Tensor): Window tensor that is applied/multiplied to each frame/window</span>
<span class="sd">        n_fft (int): Size of FFT</span>
<span class="sd">        hop_length (int): Length of hop between STFT windows</span>
<span class="sd">        win_length (int): Window size</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Dimension (..., time)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">specgram</span> <span class="o">=</span> <span class="n">spectrogram</span><span class="p">(</span><span class="n">waveform</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">pad</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">n_fft</span><span class="o">=</span><span class="n">n_fft</span><span class="p">,</span> <span class="n">hop_length</span><span class="o">=</span><span class="n">hop_length</span><span class="p">,</span>
                           <span class="n">win_length</span><span class="o">=</span><span class="n">win_length</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sample_rate</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">1</span> <span class="o">+</span> <span class="n">n_fft</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                           <span class="n">device</span><span class="o">=</span><span class="n">specgram</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">freq_dim</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">freqs</span> <span class="o">*</span> <span class="n">specgram</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">freq_dim</span><span class="p">)</span> <span class="o">/</span> <span class="n">specgram</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">freq_dim</span><span class="p">)</span></div>


<div class="viewcode-block" id="apply_codec"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.apply_codec">[docs]</a><span class="nd">@_mod_utils</span><span class="o">.</span><span class="n">requires_sox</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">apply_codec</span><span class="p">(</span>
    <span class="n">waveform</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
    <span class="n">sample_rate</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">channels_first</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">compression</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bits_per_sample</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply codecs as a form of augmentation.</span>

<span class="sd">    Args:</span>
<span class="sd">        waveform (Tensor): Audio data. Must be 2 dimensional. See also ```channels_first```.</span>
<span class="sd">        sample_rate (int): Sample rate of the audio waveform.</span>
<span class="sd">        format (str): File format.</span>
<span class="sd">        channels_first (bool):</span>
<span class="sd">            When True, both the input and output Tensor have dimension ``[channel, time]``.</span>
<span class="sd">            Otherwise, they have dimension ``[time, channel]``.</span>
<span class="sd">        compression (float): Used for formats other than WAV.</span>
<span class="sd">            For mor details see :py:func:`torchaudio.backend.sox_io_backend.save`.</span>
<span class="sd">        encoding (str, optional): Changes the encoding for the supported formats.</span>
<span class="sd">            For more details see :py:func:`torchaudio.backend.sox_io_backend.save`.</span>
<span class="sd">        bits_per_sample (int, optional): Changes the bit depth for the supported formats.</span>
<span class="sd">            For more details see :py:func:`torchaudio.backend.sox_io_backend.save`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Resulting Tensor.</span>
<span class="sd">        If ``channels_first=True``, it has ``[channel, time]`` else ``[time, channel]``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">bytes</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">torchaudio</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">sox_io_backend</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span>
                                           <span class="n">waveform</span><span class="p">,</span>
                                           <span class="n">sample_rate</span><span class="p">,</span>
                                           <span class="n">channels_first</span><span class="p">,</span>
                                           <span class="n">compression</span><span class="p">,</span>
                                           <span class="nb">format</span><span class="p">,</span>
                                           <span class="n">encoding</span><span class="p">,</span>
                                           <span class="n">bits_per_sample</span>
                                           <span class="p">)</span>
    <span class="nb">bytes</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">augmented</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torchaudio</span><span class="o">.</span><span class="n">sox_effects</span><span class="o">.</span><span class="n">sox_effects</span><span class="o">.</span><span class="n">apply_effects_file</span><span class="p">(</span>
        <span class="nb">bytes</span><span class="p">,</span> <span class="n">effects</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]],</span> <span class="n">channels_first</span><span class="o">=</span><span class="n">channels_first</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">augmented</span></div>


<div class="viewcode-block" id="compute_kaldi_pitch"><a class="viewcode-back" href="../../../functional.html#torchaudio.functional.compute_kaldi_pitch">[docs]</a><span class="k">def</span> <span class="nf">compute_kaldi_pitch</span><span class="p">(</span>
        <span class="n">waveform</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">frame_length</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">25.0</span><span class="p">,</span>
        <span class="n">frame_shift</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
        <span class="n">min_f0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">max_f0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span>
        <span class="n">soft_min_f0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
        <span class="n">penalty_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">lowpass_cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">resample_frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">,</span>
        <span class="n">delta_pitch</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span>
        <span class="n">nccf_ballast</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">7000</span><span class="p">,</span>
        <span class="n">lowpass_filter_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">upsample_filter_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">max_frames_latency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">frames_per_chunk</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">simulate_first_pass_online</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">recompute_frame</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
        <span class="n">snip_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Extract pitch based on method described in [1].</span>

<span class="sd">    This function computes the equivalent of `compute-kaldi-pitch-feats` from Kaldi.</span>

<span class="sd">    Args:</span>
<span class="sd">        waveform (Tensor):</span>
<span class="sd">            The input waveform of shape `(..., time)`.</span>
<span class="sd">        sample_rate (float):</span>
<span class="sd">            Sample rate of `waveform`.</span>
<span class="sd">        frame_length (float, optional):</span>
<span class="sd">            Frame length in milliseconds. (default: 25.0)</span>
<span class="sd">        frame_shift (float, optional):</span>
<span class="sd">            Frame shift in milliseconds. (default: 10.0)</span>
<span class="sd">        min_f0 (float, optional):</span>
<span class="sd">            Minimum F0 to search for (Hz)  (default: 50.0)</span>
<span class="sd">        max_f0 (float, optional):</span>
<span class="sd">            Maximum F0 to search for (Hz)  (default: 400.0)</span>
<span class="sd">        soft_min_f0 (float, optional):</span>
<span class="sd">            Minimum f0, applied in soft way, must not exceed min-f0  (default: 10.0)</span>
<span class="sd">        penalty_factor (float, optional):</span>
<span class="sd">            Cost factor for FO change.  (default: 0.1)</span>
<span class="sd">        lowpass_cutoff (float, optional):</span>
<span class="sd">            Cutoff frequency for LowPass filter (Hz) (default: 1000)</span>
<span class="sd">        resample_frequency (float, optional):</span>
<span class="sd">            Frequency that we down-sample the signal to. Must be more than twice lowpass-cutoff.</span>
<span class="sd">            (default: 4000)</span>
<span class="sd">        delta_pitch( float, optional):</span>
<span class="sd">            Smallest relative change in pitch that our algorithm measures. (default: 0.005)</span>
<span class="sd">        nccf_ballast (float, optional):</span>
<span class="sd">            Increasing this factor reduces NCCF for quiet frames (default: 7000)</span>
<span class="sd">        lowpass_filter_width (int, optional):</span>
<span class="sd">            Integer that determines filter width of lowpass filter, more gives sharper filter.</span>
<span class="sd">            (default: 1)</span>
<span class="sd">        upsample_filter_width (int, optional):</span>
<span class="sd">            Integer that determines filter width when upsampling NCCF. (default: 5)</span>
<span class="sd">        max_frames_latency (int, optional):</span>
<span class="sd">            Maximum number of frames of latency that we allow pitch tracking to introduce into</span>
<span class="sd">            the feature processing (affects output only if ``frames_per_chunk &gt; 0`` and</span>
<span class="sd">            ``simulate_first_pass_online=True``) (default: 0)</span>
<span class="sd">        frames_per_chunk (int, optional):</span>
<span class="sd">            The number of frames used for energy normalization. (default: 0)</span>
<span class="sd">        simulate_first_pass_online (bool, optional):</span>
<span class="sd">            If true, the function will output features that correspond to what an online decoder</span>
<span class="sd">            would see in the first pass of decoding -- not the final version of the features,</span>
<span class="sd">            which is the default. (default: False)</span>
<span class="sd">            Relevant if ``frames_per_chunk &gt; 0``.</span>
<span class="sd">        recompute_frame (int, optional):</span>
<span class="sd">            Only relevant for compatibility with online pitch extraction.</span>
<span class="sd">            A non-critical parameter; the frame at which we recompute some of the forward pointers,</span>
<span class="sd">            after revising our estimate of the signal energy.</span>
<span class="sd">            Relevant if ``frames_per_chunk &gt; 0``. (default: 500)</span>
<span class="sd">        snip_edges (bool, optional):</span>
<span class="sd">            If this is set to false, the incomplete frames near the ending edge won&#39;t be snipped,</span>
<span class="sd">            so that the number of frames is the file size divided by the frame-shift.</span>
<span class="sd">            This makes different types of features give the same number of frames. (default: True)</span>

<span class="sd">    Returns:</span>
<span class="sd">       Tensor: Pitch feature. Shape: ``(batch, frames 2)`` where the last dimension</span>
<span class="sd">       corresponds to pitch and NCCF.</span>

<span class="sd">    Reference:</span>
<span class="sd">        - A pitch extraction algorithm tuned for automatic speech recognition</span>

<span class="sd">          P. Ghahremani, B. BabaAli, D. Povey, K. Riedhammer, J. Trmal and S. Khudanpur</span>

<span class="sd">          2014 IEEE International Conference on Acoustics, Speech and Signal Processing (ICASSP),</span>

<span class="sd">          Florence, 2014, pp. 2494-2498, doi: 10.1109/ICASSP.2014.6854049.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">waveform</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">waveform</span> <span class="o">=</span> <span class="n">waveform</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">torchaudio</span><span class="o">.</span><span class="n">kaldi_ComputeKaldiPitch</span><span class="p">(</span>
        <span class="n">waveform</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">frame_length</span><span class="p">,</span> <span class="n">frame_shift</span><span class="p">,</span>
        <span class="n">min_f0</span><span class="p">,</span> <span class="n">max_f0</span><span class="p">,</span> <span class="n">soft_min_f0</span><span class="p">,</span> <span class="n">penalty_factor</span><span class="p">,</span> <span class="n">lowpass_cutoff</span><span class="p">,</span>
        <span class="n">resample_frequency</span><span class="p">,</span> <span class="n">delta_pitch</span><span class="p">,</span> <span class="n">nccf_ballast</span><span class="p">,</span>
        <span class="n">lowpass_filter_width</span><span class="p">,</span> <span class="n">upsample_filter_width</span><span class="p">,</span> <span class="n">max_frames_latency</span><span class="p">,</span>
        <span class="n">frames_per_chunk</span><span class="p">,</span> <span class="n">simulate_first_pass_online</span><span class="p">,</span> <span class="n">recompute_frame</span><span class="p">,</span>
        <span class="n">snip_edges</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">result</span></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Torchaudio Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/language_data.js"></script>
         <script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"></script>
         <script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"></script>
         <script src="../../../_static/katex_autorenderer.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Stay Connected</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://twitter.us14.list-manage.com/subscribe/post?u=75419c71fe0a935e53dfa4a3f&id=91d0dccd39"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>

          <div class="footer-social-icons">
            <a href="https://www.facebook.com/pytorch" target="_blank" class="facebook"></a>
            <a href="https://twitter.com/pytorch" target="_blank" class="twitter"></a>
            <a href="https://www.youtube.com/pytorch" target="_blank" class="youtube"></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/hub">PyTorch Hub</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/elastic/">TorchElastic</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>