# Checkout or reuse existing work directory based on TARGET_COMMIT,
# build our static dependencies, and cd into the workdir
#
# Requires script_dir to be set, to a directory one BELOW this
# script (satisfied by conda/ and wheel/)  Yeah this is hella
# janky

if [[ "$TARGET_COMMIT" == HEAD ]]; then
  # Assume that this script was called from a valid checkout
  WORKDIR="$script_dir/../../.."
else
  WORKDIR="/tmp/audio"
  cd /tmp
  rm -rf audio
  git clone https://github.com/pytorch/audio
  cd audio
  git checkout "$TARGET_COMMIT"
  git submodule update --init --recursive
fi

mkdir "$WORKDIR/third_party"
"$script_dir/../build_from_source.sh" "$WORKDIR"

cd "$WORKDIR"
