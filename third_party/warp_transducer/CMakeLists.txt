IF(APPLE)
    CMAKE_MINIMUM_REQUIRED(VERSION 3.4)
ELSE()
    CMAKE_MINIMUM_REQUIRED(VERSION 2.8)
ENDIF()

PROJECT(rnnt_release)

IF(APPLE)
    SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++11 -O2")
    ADD_DEFINITIONS(-DAPPLE)
ELSE()
    SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -O2")
ENDIF()

INCLUDE_DIRECTORIES(submodule/include)

SET(CMAKE_POSITION_INDEPENDENT_CODE ON)

ADD_DEFINITIONS(-DRNNT_DISABLE_OMP)

IF(APPLE)
    EXEC_PROGRAM(uname ARGS -v  OUTPUT_VARIABLE DARWIN_VERSION)
    STRING(REGEX MATCH "[0-9]+" DARWIN_VERSION ${DARWIN_VERSION})
    MESSAGE(STATUS "DARWIN_VERSION=${DARWIN_VERSION}")

    # for el capitain have to use rpath
    IF(DARWIN_VERSION LESS 15)
        SET(CMAKE_SKIP_RPATH TRUE)
    ENDIF()

ELSE()
    # always skip for linux
    SET(CMAKE_SKIP_RPATH TRUE)
ENDIF()

IF(NOT APPLE)
    SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++11 -O2")
ENDIF()

ADD_LIBRARY(warprnnt STATIC submodule/src/rnnt_entrypoint.cpp)

INSTALL(TARGETS warprnnt
        RUNTIME DESTINATION "bin"
        LIBRARY DESTINATION "lib"
        ARCHIVE DESTINATION "lib")

INSTALL(FILES submodule/include/rnnt.h DESTINATION "submodule/include")
